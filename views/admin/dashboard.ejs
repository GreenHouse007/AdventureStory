<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head') %>
  </head>
  <body>
    <%- include('../partials/header', { user }) %>

    <main class="container admin-dashboard">
      <h1 class="title">Admin Dashboard</h1>

      <% if (flash && flash.message) { %>
      <div class="flash flash-<%= flash.type === 'error' ? 'error' : 'success' %>">
        <%= flash.message %>
      </div>
      <% } %>

      <section class="stats-grid">
        <div class="stat-card">
          <h2><%= stats.userCount %></h2>
          <p>Users</p>
        </div>
        <div class="stat-card">
          <h2><%= stats.storyCount %></h2>
          <p>Stories</p>
        </div>
      </section>

      <section class="admin-links">
        <a href="/admin/users" class="cta-button">Manage Users</a>
        <a href="/admin/stories" class="cta-button">Manage Stories</a>
        <a href="/admin/stories/seeds" class="cta-button secondary"
          >Upload Story Seed</a
        >
      </section>

      <section class="review-section">
        <header class="review-header">
          <h2>Pending user stories</h2>
          <p class="muted">
            Review community submissions and decide whether they are ready for
            the public library.
          </p>
        </header>

        <% if (!pendingStories || pendingStories.length === 0) { %>
        <p class="muted">No stories are awaiting review.</p>
        <% } else { %>
        <div class="review-grid">
          <% pendingStories.forEach(function (story) { %>
          <article class="review-card">
            <header class="review-card__header">
              <h3><%= story.title %></h3>
              <span class="story-status story-status-<%= story.status %>">
                <%= story.statusLabel %>
              </span>
            </header>
            <p class="muted">
              Submitted by
              <strong><%= story.author?.username || 'Unknown author' %></strong>
              on
              <%= story.submittedAt
                ? new Date(story.submittedAt).toLocaleString()
                : new Date(story.updatedAt || story.createdAt).toLocaleString() %>
            </p>
            <div class="review-card__actions">
              <a class="cta-button small ghost" href="/u/story/<%= story._id %>"
                >Preview</a
              >
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/approve"
                class="inline-form"
              >
                <button type="submit" class="cta-button small">Approve</button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/under-review"
                class="inline-form"
              >
                <button type="submit" class="cta-button small ghost">
                  Mark under review
                </button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/reject"
                class="inline-form"
              >
                <button type="submit" class="cta-button small danger">
                  Reject
                </button>
              </form>
            </div>
          </article>
          <% }) %>
        </div>
        <% } %>
      </section>

      <section class="review-section">
        <header class="review-header">
          <h2>Published & under-review user stories</h2>
          <p class="muted">
            Use these tools to temporarily pull stories from the public library
            or return them once issues are resolved.
          </p>
        </header>

        <% if (!managedStories || managedStories.length === 0) { %>
        <p class="muted">No published community stories need attention.</p>
        <% } else { %>
        <div class="review-grid">
          <% managedStories.forEach(function (story) { %>
          <article class="review-card">
            <header class="review-card__header">
              <h3><%= story.title %></h3>
              <span class="story-status story-status-<%= story.status %>">
                <%= story.statusLabel %>
              </span>
            </header>
            <p class="muted">
              Author:
              <strong><%= story.author?.username || 'Unknown author' %></strong>
            </p>
            <div class="review-card__actions">
              <a class="cta-button small ghost" href="/u/story/<%= story._id %>"
                >Preview</a
              >
              <% if (story.status === 'under_review') { %>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/approve"
                class="inline-form"
              >
                <button type="submit" class="cta-button small">Publish</button>
              </form>
              <% } else { %>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/under-review"
                class="inline-form"
              >
                <button type="submit" class="cta-button small ghost">
                  Mark under review
                </button>
              </form>
              <% } %>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/remove"
                class="inline-form"
              >
                <button type="submit" class="cta-button small danger">
                  Remove from public
                </button>
              </form>
            </div>
          </article>
          <% }) %>
        </div>
        <% } %>
      </section>
    </main>

    <%- include('../partials/footer') %>

    <style>
      .admin-dashboard {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding-bottom: 4rem;
      }

      .flash {
        padding: 0.9rem 1.1rem;
        border-radius: 12px;
        font-weight: 600;
      }

      .flash-success {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
      }

      .flash-error {
        background: rgba(248, 113, 113, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #fecaca;
      }

      .review-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .review-header h2 {
        margin: 0;
      }

      .review-grid {
        display: grid;
        gap: 1rem;
      }

      .review-card {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        padding: 1.25rem;
        background: rgba(15, 23, 42, 0.75);
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .review-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .review-card__header h3 {
        margin: 0;
        font-size: 1.15rem;
      }

      .review-card__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
      }

      .review-card__actions .inline-form {
        margin: 0;
      }

      .story-status {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        font-size: 0.78rem;
        text-transform: uppercase;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(148, 163, 184, 0.12);
        color: #e2e8f0;
      }

      .story-status-public {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
      }

      .story-status-pending,
      .story-status-coming_soon {
        background: rgba(59, 130, 246, 0.18);
        border-color: rgba(59, 130, 246, 0.32);
        color: #bfdbfe;
      }

      .story-status-under_review {
        background: rgba(244, 114, 182, 0.2);
        border-color: rgba(244, 114, 182, 0.35);
        color: #fbcfe8;
      }

      .story-status-private {
        background: rgba(148, 163, 184, 0.12);
        border-color: rgba(148, 163, 184, 0.32);
        color: #cbd5f5;
      }

      .cta-button.small.danger {
        background: #7f1d1d;
      }

      .cta-button.small.danger:hover {
        background: #b91c1c;
      }

      @media (max-width: 720px) {
        .review-card__header {
          flex-direction: column;
          align-items: flex-start;
        }

        .review-card__actions {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </body>
</html>
