<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head') %>
  </head>
  <body>
    <%- include('../partials/header', { user }) %>

    <main class="container admin-dashboard">
      <h1 class="title">Admin Dashboard</h1>

      <% if (flash && flash.message) { %>
      <div class="flash flash-<%= flash.type === 'error' ? 'error' : 'success' %>">
        <%= flash.message %>
      </div>
      <% } %>

      <section class="stats-grid">
        <div class="stat-card">
          <h2><%= stats.userCount %></h2>
          <p>Users</p>
        </div>
        <div class="stat-card">
          <h2><%= stats.storyCount %></h2>
          <p>Stories</p>
        </div>
      </section>

      <section class="admin-links">
        <a href="/admin/users" class="cta-button">Manage Users</a>
        <a href="/admin/stories" class="cta-button">Manage Stories</a>
        <a href="/admin/stories/seeds" class="cta-button secondary"
          >Upload Story Seed</a
        >
      </section>

      <section class="review-section">
        <header class="review-header">
          <h2>Pending user stories</h2>
          <p class="muted">
            Review new submissions and decide whether they are ready for the
            community library.
          </p>
        </header>

        <form method="get" class="filter-form">
          <div class="filter-form__row">
            <label class="filter-field">
              <span class="filter-label">Search</span>
              <input
                type="search"
                name="pendingSearch"
                value="<%= filters.pending.search %>"
                placeholder="Search by title or author"
              />
            </label>
            <label class="filter-field">
              <span class="filter-label">Categories</span>
              <select name="pendingCategories" multiple size="5">
                <% categories.forEach(function (cat) { %>
                <option
                  value="<%= cat %>"
                  <%= filters.pending.categories.includes(cat) ? 'selected' : '' %>
                >
                  <%= cat %>
                </option>
                <% }) %>
              </select>
            </label>
          </div>
          <div class="filter-form__actions">
            <button type="submit" class="btn small">Apply filters</button>
            <a href="/admin" class="btn small ghost">Reset</a>
          </div>
          <input
            type="hidden"
            name="underReviewSearch"
            value="<%= filters.underReview.search %>"
          />
          <% filters.underReview.categories.forEach(function (cat) { %>
          <input type="hidden" name="underReviewCategories" value="<%= cat %>" />
          <% }) %>
          <input
            type="hidden"
            name="publishedSearch"
            value="<%= filters.published.search %>"
          />
          <% filters.published.categories.forEach(function (cat) { %>
          <input type="hidden" name="publishedCategories" value="<%= cat %>" />
          <% }) %>
        </form>

        <% if (!pendingStories || pendingStories.length === 0) { %>
        <p class="muted empty-message">No pending stories match your filters.</p>
        <% } else { %>
        <div class="review-grid">
          <% pendingStories.forEach(function (story) { %>
          <article class="review-card">
            <header class="review-card__header">
              <h3><%= story.title %></h3>
              <span class="story-status story-status-<%= story.status %>">
                <%= story.statusLabel %>
              </span>
            </header>
            <p class="muted">
              Submitted by
              <strong><%= story.authorName %></strong>
              <%= story.submittedAt
                ? `on ${new Date(story.submittedAt).toLocaleString()}`
                : '' %>
            </p>
            <% if (story.categories && story.categories.length) { %>
            <ul class="story-tag-list">
              <% story.categories.forEach(function (cat) { %>
              <li class="story-tag"><%= cat %></li>
              <% }) %>
            </ul>
            <% } %>
            <div class="review-card__actions">
              <a
                class="cta-button small ghost"
                href="/u/story/<%= story._id %>?adminPreview=1&return=<%= encodedReturnTo %>"
                >Preview</a
              >
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/approve"
                class="inline-form"
              >
                <button type="submit" class="cta-button small">Approve</button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/under-review"
                class="inline-form"
              >
                <button type="submit" class="cta-button small ghost">
                  Mark under review
                </button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/reject"
                class="inline-form"
              >
                <button type="submit" class="cta-button small danger">
                  Reject
                </button>
              </form>
            </div>
            <form
              class="note-form"
              method="post"
              action="/admin/user-stories/<%= story._id %>/note"
            >
              <label class="sr-only" for="pending-note-<%= story._id %>">Review note</label>
              <textarea
                id="pending-note-<%= story._id %>"
                name="reviewNote"
                rows="3"
                placeholder="Leave a note for the author"
              ><%= story.reviewNote || '' %></textarea>
              <input type="hidden" name="returnTo" value="<%= currentQuery %>" />
              <div class="note-form__actions">
                <button type="submit" class="btn small">Save note</button>
                <% if (story.reviewNote) { %>
                <button
                  type="submit"
                  name="clearNote"
                  value="1"
                  class="btn small ghost"
                >
                  Remove note
                </button>
                <% } %>
              </div>
            </form>
          </article>
          <% }) %>
        </div>
        <% } %>
      </section>

      <section class="review-section">
        <header class="review-header">
          <h2>Stories under review</h2>
          <p class="muted">
            Follow up on stories pulled for edits and publish them once issues
            are resolved.
          </p>
        </header>

        <form method="get" class="filter-form">
          <div class="filter-form__row">
            <label class="filter-field">
              <span class="filter-label">Search</span>
              <input
                type="search"
                name="underReviewSearch"
                value="<%= filters.underReview.search %>"
                placeholder="Search by title or author"
              />
            </label>
            <label class="filter-field">
              <span class="filter-label">Categories</span>
              <select name="underReviewCategories" multiple size="5">
                <% categories.forEach(function (cat) { %>
                <option
                  value="<%= cat %>"
                  <%= filters.underReview.categories.includes(cat) ? 'selected' : '' %>
                >
                  <%= cat %>
                </option>
                <% }) %>
              </select>
            </label>
          </div>
          <div class="filter-form__actions">
            <button type="submit" class="btn small">Apply filters</button>
            <a href="/admin" class="btn small ghost">Reset</a>
          </div>
          <input
            type="hidden"
            name="pendingSearch"
            value="<%= filters.pending.search %>"
          />
          <% filters.pending.categories.forEach(function (cat) { %>
          <input type="hidden" name="pendingCategories" value="<%= cat %>" />
          <% }) %>
          <input
            type="hidden"
            name="publishedSearch"
            value="<%= filters.published.search %>"
          />
          <% filters.published.categories.forEach(function (cat) { %>
          <input type="hidden" name="publishedCategories" value="<%= cat %>" />
          <% }) %>
        </form>

        <% if (!underReviewStories || underReviewStories.length === 0) { %>
        <p class="muted empty-message">No stories are currently under review.</p>
        <% } else { %>
        <div class="review-grid">
          <% underReviewStories.forEach(function (story) { %>
          <article class="review-card">
            <header class="review-card__header">
              <h3><%= story.title %></h3>
              <span class="story-status story-status-<%= story.status %>">
                <%= story.statusLabel %>
              </span>
            </header>
            <p class="muted">
              Author: <strong><%= story.authorName %></strong>
            </p>
            <% if (story.categories && story.categories.length) { %>
            <ul class="story-tag-list">
              <% story.categories.forEach(function (cat) { %>
              <li class="story-tag"><%= cat %></li>
              <% }) %>
            </ul>
            <% } %>
            <div class="review-card__actions">
              <a
                class="cta-button small ghost"
                href="/u/story/<%= story._id %>?adminPreview=1&return=<%= encodedReturnTo %>"
                >Preview</a
              >
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/approve"
                class="inline-form"
              >
                <button type="submit" class="cta-button small">Publish</button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/remove"
                class="inline-form"
              >
                <button type="submit" class="cta-button small danger">
                  Remove from public
                </button>
              </form>
            </div>
            <form
              class="note-form"
              method="post"
              action="/admin/user-stories/<%= story._id %>/note"
            >
              <label class="sr-only" for="under-review-note-<%= story._id %>"
                >Review note</label
              >
              <textarea
                id="under-review-note-<%= story._id %>"
                name="reviewNote"
                rows="3"
                placeholder="Leave a note for the author"
              ><%= story.reviewNote || '' %></textarea>
              <input type="hidden" name="returnTo" value="<%= currentQuery %>" />
              <div class="note-form__actions">
                <button type="submit" class="btn small">Save note</button>
                <% if (story.reviewNote) { %>
                <button
                  type="submit"
                  name="clearNote"
                  value="1"
                  class="btn small ghost"
                >
                  Remove note
                </button>
                <% } %>
              </div>
            </form>
          </article>
          <% }) %>
        </div>
        <% } %>
      </section>

      <section class="review-section">
        <header class="review-header">
          <h2>Published user stories</h2>
          <p class="muted">
            Search and filter public community stories. Pull a story for edits or
            remove it from the library if necessary.
          </p>
        </header>

        <form method="get" class="filter-form">
          <div class="filter-form__row">
            <label class="filter-field">
              <span class="filter-label">Search</span>
              <input
                type="search"
                name="publishedSearch"
                value="<%= filters.published.search %>"
                placeholder="Search by title or author"
              />
            </label>
            <label class="filter-field">
              <span class="filter-label">Categories</span>
              <select name="publishedCategories" multiple size="5">
                <% categories.forEach(function (cat) { %>
                <option
                  value="<%= cat %>"
                  <%= filters.published.categories.includes(cat) ? 'selected' : '' %>
                >
                  <%= cat %>
                </option>
                <% }) %>
              </select>
            </label>
          </div>
          <div class="filter-form__actions">
            <button type="submit" class="btn small">Apply filters</button>
            <a href="/admin" class="btn small ghost">Reset</a>
          </div>
          <input
            type="hidden"
            name="pendingSearch"
            value="<%= filters.pending.search %>"
          />
          <% filters.pending.categories.forEach(function (cat) { %>
          <input type="hidden" name="pendingCategories" value="<%= cat %>" />
          <% }) %>
          <input
            type="hidden"
            name="underReviewSearch"
            value="<%= filters.underReview.search %>"
          />
          <% filters.underReview.categories.forEach(function (cat) { %>
          <input type="hidden" name="underReviewCategories" value="<%= cat %>" />
          <% }) %>
        </form>

        <% if (!publishedStories || publishedStories.length === 0) { %>
        <p class="muted empty-message">No published stories match your filters.</p>
        <% } else { %>
        <div class="review-grid">
          <% publishedStories.forEach(function (story) { %>
          <article class="review-card">
            <header class="review-card__header">
              <h3><%= story.title %></h3>
              <span class="story-status story-status-<%= story.status %>">
                <%= story.statusLabel %>
              </span>
            </header>
            <p class="muted">
              Author: <strong><%= story.authorName %></strong>
            </p>
            <% if (story.categories && story.categories.length) { %>
            <ul class="story-tag-list">
              <% story.categories.forEach(function (cat) { %>
              <li class="story-tag"><%= cat %></li>
              <% }) %>
            </ul>
            <% } %>
            <div class="review-card__actions">
              <a
                class="cta-button small ghost"
                href="/u/story/<%= story._id %>?adminPreview=1&return=<%= encodedReturnTo %>"
                >Preview</a
              >
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/under-review"
                class="inline-form"
              >
                <button type="submit" class="cta-button small ghost">
                  Mark under review
                </button>
              </form>
              <form
                method="post"
                action="/admin/user-stories/<%= story._id %>/remove"
                class="inline-form"
              >
                <button type="submit" class="cta-button small danger">
                  Remove from public
                </button>
              </form>
            </div>
            <form
              class="note-form"
              method="post"
              action="/admin/user-stories/<%= story._id %>/note"
            >
              <label class="sr-only" for="published-note-<%= story._id %>"
                >Review note</label
              >
              <textarea
                id="published-note-<%= story._id %>"
                name="reviewNote"
                rows="3"
                placeholder="Leave a note for the author"
              ><%= story.reviewNote || '' %></textarea>
              <input type="hidden" name="returnTo" value="<%= currentQuery %>" />
              <div class="note-form__actions">
                <button type="submit" class="btn small">Save note</button>
                <% if (story.reviewNote) { %>
                <button
                  type="submit"
                  name="clearNote"
                  value="1"
                  class="btn small ghost"
                >
                  Remove note
                </button>
                <% } %>
              </div>
            </form>
          </article>
          <% }) %>
        </div>
        <% } %>
      </section>
    </main>

    <%- include('../partials/footer') %>

    <style>
      .admin-dashboard {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        padding-bottom: 4rem;
      }

      .flash {
        padding: 0.9rem 1.1rem;
        border-radius: 12px;
        font-weight: 600;
      }

      .flash-success {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
      }

      .flash-error {
        background: rgba(248, 113, 113, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.3);
        color: #fecaca;
      }

      .review-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .review-header h2 {
        margin: 0;
      }

      .review-grid {
        display: grid;
        gap: 1rem;
      }

      .review-card {
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 16px;
        padding: 1.25rem;
        background: rgba(15, 23, 42, 0.75);
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .filter-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.65);
      }

      .filter-form__row {
        display: grid;
        gap: 0.75rem;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .filter-field {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.85rem;
        color: rgba(203, 213, 225, 0.8);
      }

      .filter-field input,
      .filter-field select,
      .note-form textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.9);
        color: #f8fafc;
        padding: 0.55rem 0.75rem;
        font-size: 0.95rem;
      }

      .filter-field select {
        min-height: 7.5rem;
      }

      .filter-form__actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .filter-label {
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.8);
      }

      .empty-message {
        font-size: 0.9rem;
        color: rgba(148, 163, 184, 0.85);
      }

      .story-tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin: 0;
        padding: 0;
        list-style: none;
      }

      .story-tag {
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.75rem;
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid rgba(59, 130, 246, 0.32);
        color: #dbeafe;
      }

      .note-form {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.25rem;
      }

      .note-form textarea {
        resize: vertical;
        min-height: 5.5rem;
      }

      .note-form__actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      .review-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .review-card__header h3 {
        margin: 0;
        font-size: 1.15rem;
      }

      .review-card__actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
      }

      .review-card__actions .inline-form {
        margin: 0;
      }

      .story-status {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.75rem;
        border-radius: 999px;
        font-size: 0.78rem;
        text-transform: uppercase;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(148, 163, 184, 0.12);
        color: #e2e8f0;
      }

      .story-status-public {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
      }

      .story-status-pending,
      .story-status-coming_soon {
        background: rgba(59, 130, 246, 0.18);
        border-color: rgba(59, 130, 246, 0.32);
        color: #bfdbfe;
      }

      .story-status-under_review {
        background: rgba(244, 114, 182, 0.2);
        border-color: rgba(244, 114, 182, 0.35);
        color: #fbcfe8;
      }

      .story-status-private {
        background: rgba(148, 163, 184, 0.12);
        border-color: rgba(148, 163, 184, 0.32);
        color: #cbd5f5;
      }

      .cta-button.small.danger {
        background: #7f1d1d;
      }

      .cta-button.small.danger:hover {
        background: #b91c1c;
      }

      @media (max-width: 720px) {
        .review-card__header {
          flex-direction: column;
          align-items: flex-start;
        }

        .review-card__actions {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </body>
</html>
