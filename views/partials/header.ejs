<header class="site-header">
  <h1>Shadow Paths</h1>
  <button
    class="menu-toggle"
    type="button"
    aria-expanded="false"
    aria-controls="primary-navigation"
  >
    <span class="sr-only">Toggle navigation</span>
    <span class="menu-toggle__bar" aria-hidden="true"></span>
    <span class="menu-toggle__bar" aria-hidden="true"></span>
    <span class="menu-toggle__bar" aria-hidden="true"></span>
  </button>
  <nav class="top-nav" id="primary-navigation" data-visible="true">
    <a href="/">Home</a>
    <a href="/u/library">Library</a>
    <a href="/about">About</a>

    <% if (user) { %>
    <a href="/u/stats">My Stats</a>
    <a href="/u/authors">Authors</a>

    <% if (user.role === 'admin') { %>
    <a href="/admin">Admin</a>
    <% } %>

    <!-- Logout as a link but still POST under the hood -->
    <form action="/logout" method="post" class="logout-form">
      <button type="submit">Logout</button>
    </form>
    <% } else { %>
    <a href="/login">Login</a>
    <a href="/signup">Sign Up</a>
    <% } %>
  </nav>
</header>
<script>
  (() => {
    const toggle = document.querySelector('.menu-toggle');
    const nav = document.getElementById('primary-navigation');
    if (!toggle || !nav) {
      return;
    }

    const setState = (expanded) => {
      toggle.setAttribute('aria-expanded', String(expanded));
      nav.dataset.visible = String(expanded);
    };

    setState(false);

    toggle.addEventListener('click', () => {
      const expanded = toggle.getAttribute('aria-expanded') === 'true';
      setState(!expanded);
    });
  })();
</script>
<% if (firebaseConfig && firebaseConfig.apiKey) { %>
<script type="module">
  import {
    initializeApp,
    getApps,
    getApp,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const config = <%- JSON.stringify(firebaseConfig) %>;
  if (config.apiKey) {
    const app = getApps().length ? getApp() : initializeApp(config);
    const auth = getAuth(app);

    document.querySelectorAll("form.logout-form").forEach((form) => {
      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        try {
          await signOut(auth);
        } catch (error) {
          console.warn("Firebase sign-out failed", error);
        }

        try {
          await fetch(form.action || "/logout", {
            method: "POST",
            credentials: "same-origin",
          });
        } catch (error) {
          console.warn("Logout request failed", error);
        }

        window.location.assign("/");
      });
    });
  }
</script>
<% } %>
