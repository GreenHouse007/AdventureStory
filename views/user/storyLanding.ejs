<!-- views/user/storyLanding.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head') %>
  </head>
  <body>
    <%- include('../partials/header', { user }) %>

    <main class="container">
      <% const access = storyAccess || {}; %>
      <h1><%= story?.title || 'Untitled Story' %></h1>
      <img
        src="<%= story?.coverImage || '/images/default-cover.svg' %>"
        class="cover"
        alt="Cover image for <%= story?.title || 'story' %>"
      />
      <p><%= story?.description || '' %></p>

      <% if (access && access.status && access.status !== 'public') { %>
      <div class="story-status-banner story-status-<%= access.status %>">
        <span class="story-status-label"><%= access.statusLabel %></span>
        <% if (access.isOwner && access.canPlay && access.isUserStory) { %>
        <small>You can preview your own story even while it's under review.</small>
        <% } %>
      </div>
      <% } %>

      <% if (Array.isArray(story?.categories) && story.categories.length) { %>
      <section class="story-categories">
        <h2 class="story-categories__heading">Categories</h2>
        <ul class="tag-list">
          <% story.categories.forEach(function (cat) { %>
          <li class="tag"><%= cat %></li>
          <% }) %>
        </ul>
      </section>
      <% } %>

      <% if (progress && progress.totalEndings > 0) { %>
      <div class="ending-progress-card">
        <div class="ending-progress-card__count">
          <span class="found"><%= progress.foundCount %></span>
          <span class="divider">/</span>
          <span class="total"><%= progress.totalEndings %></span>
        </div>
        <span class="ending-progress-card__label">Endings discovered</span>
      </div>
      <% } %>

      <div class="actions stack">
        <% if (access.canPlay && startNodeId) { %>
        <a
          href="/u/play/<%= story._id %>/<%= startNodeId %>"
          class="cta-button"
        >
          Start from Beginning
        </a>
        <% } else if (!access.canPlay) { %>
        <div class="story-status-message story-status-<%= access.status %>">
          <span class="story-status-label"><%= access.statusLabel %></span>
          <p class="muted">
            <% if (access.status === 'pending') { %>
            This story is pending review and will be available soon.
            <% } else if (access.status === 'under_review') { %>
            This story is currently under review.
            <% } else if (access.status === 'coming_soon') { %>
            This adventure is coming soon. Check back later!
            <% } else { %>
            This story is not available to play right now.
            <% } %>
          </p>
        </div>
        <% } else if (!startNodeId) { %>
        <p class="muted">This story doesn't have a starting node yet.</p>
        <% } %>

        <% if (access.canPlay && continueNodeId) { %>
        <a
          href="/u/play/<%= story._id %>/<%= continueNodeId %>"
          class="cta-button ghost"
        >
          Continue where you left off
        </a>
        <% } %>
      </div>
      <% if (lockedPaths && lockedPaths.total > 0) { %>
      <p class="locked-path-summary">
        This story has <%= lockedPaths.total %> locked paths in it. You have
        unlocked: <%= lockedPaths.unlocked %>
      </p>
      <% } %>
    </main>

    <%- include('../partials/footer') %>
    <style>
      .ending-progress-card {
        margin: 1.5rem 0;
        padding: 1rem 1.4rem;
        border-radius: 16px;
        background: linear-gradient(135deg, #4338ca, #6366f1);
        color: #fff;
        display: inline-flex;
        flex-direction: column;
        gap: 0.4rem;
        box-shadow: 0 16px 32px rgba(79, 70, 229, 0.25);
      }

      .ending-progress-card__count {
        font-size: 1.6rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        display: inline-flex;
        align-items: baseline;
        gap: 0.35rem;
      }

      .ending-progress-card__count .divider {
        opacity: 0.8;
      }

      .ending-progress-card__label {
        font-size: 0.85rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        opacity: 0.85;
      }

      .story-categories {
        margin: 1.5rem 0 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
      }

      .story-categories__heading {
        font-size: 0.9rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #94a3b8;
        margin: 0;
      }

      .actions.stack {
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
        margin-top: 1.75rem;
      }

      .actions.stack .cta-button {
        flex: 1 1 220px;
        min-width: 200px;
      }

      .cta-button.ghost {
        background: transparent;
        border: 1px solid rgba(148, 163, 184, 0.5);
        color: #e2e8f0;
      }

      .cta-button.ghost:hover {
        background: rgba(148, 163, 184, 0.12);
      }

      .locked-path-summary {
        margin-top: 2.5rem;
        font-size: 0.85rem;
        color: rgba(148, 163, 184, 0.85);
      }
    </style>
  </body>
</html>
